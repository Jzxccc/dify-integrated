# 设计文档

## 架构概览
本项目扩展现有的 Dify 集成功能，通过创建特定于应用的模块来与 ID 为 d2a5c47c-5644-49f0-bc20-6a67ac1a7b69 的 Dify 应用进行通信。架构遵循现有的分层模式，包含控制器层、服务层、数据访问层和数据传输对象。

## 组件设计

### 1. 数据库实体设计
- **AppInteraction**: 存储与特定 Dify 应用的交互记录
  - interactionId: 唯一标识符
  - appId: 目标应用 ID (d2a5c47c-5644-49f0-bc20-6a67ac1a7b69)
  - userId: 用户标识符
  - input: 用户输入内容
  - output: 应用输出内容
  - timestamp: 交互时间戳
  - metadata: 附加元数据（JSON 格式）

### 2. 特定应用 API 客户端
- **功能**: 与特定 Dify 应用进行通信
- **实现**: 扩展现有的 WebClient 配置
- **配置**: 通过配置类管理应用特定的 API 端点

### 3. 业务逻辑层
- **AppInteractionService**: 处理应用交互的业务逻辑
  - 与特定应用通信
  - 数据持久化逻辑
  - 与现有服务的集成

### 4. 数据访问层
- **AppInteractionRepository**: JPA 存储库接口
  - 提供与 AppInteraction 实体的数据库交互
  - 支持按应用 ID、用户 ID 等条件查询

## 数据流
1. 用户通过前端界面发起与特定 Dify 应用的交互请求
2. 请求发送到新的控制器端点
3. 控制器调用 AppInteractionService
4. 服务使用特定应用客户端与 Dify 应用通信
5. 收到响应后，服务将交互数据持久化到 PostgreSQL 数据库
6. 最终响应返回给前端界面

## 数据持久化逻辑
- 每次与目标应用的交互都会创建一个新的 AppInteraction 记录
- 输入和输出数据都会被存储，以便后续分析和审计
- 使用事务确保数据一致性
- 实现适当的数据索引以优化查询性能

## 安全考虑
- 确保应用特定的 API 访问受到适当控制
- 实现适当的认证和授权机制
- 对敏感信息进行适当处理